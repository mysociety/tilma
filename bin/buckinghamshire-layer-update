#!/bin/bash

set -e

source /data/mysociety/shlib/deployfns
read_conf "$(dirname "$0")/../conf/general.yml"

# Ensure that the SSH keys for the SFTP server have been accepted
[ -e ~/.ssh/known_hosts ] || install -D -m 0644 /dev/null ~/.ssh/known_hosts
grep $OPTION_buckinghamshire__host ~/.ssh/known_hosts >/dev/null || ssh-keyscan $OPTION_buckinghamshire__host >> ~/.ssh/known_hosts

TMPDIR=$(mktemp -d) || exit 1
trap 'rm -rf "$TMPDIR"' EXIT
cd $TMPDIR

curl -s -O -u $OPTION_buckinghamshire__username:$OPTION_buckinghamshire__password \
    "sftp://$OPTION_buckinghamshire__host$OPTION_buckinghamshire__dir/WholeStreetAsset.{dat,id,map,TAB}"
curl -s -O -u $OPTION_buckinghamshire__username:$OPTION_buckinghamshire__password \
    "sftp://$OPTION_buckinghamshire__host$OPTION_buckinghamshire__dir/HWGullyAsset.{dat,id,map,TAB}"
curl -s -O -u $OPTION_buckinghamshire__username:$OPTION_buckinghamshire__password \
    "sftp://$OPTION_buckinghamshire__host$OPTION_buckinghamshire__dir/HWLightingAsset.{dat,id,map,TAB}"
mv ./*.{dat,id,map,TAB} $OPTION_buckinghamshire__out
