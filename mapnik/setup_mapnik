# Instructions from http://wiki.openstreetmap.org/wiki/Mapnik
# Ignoring the database set-up, assume that's done separately.

# 1. Get the external shapefile data for low level things

BASE_DIR=/export/vhost/tilma.mysociety.org
NAME=`hostname`
HOST=$NAME.ukcod.org.uk

cd $BASE_DIR
mkdir -p tmp

if [[ "$@" =~ 'boundaries' ]]
then
    cd tmp
    wget http://tile.openstreetmap.org/world_boundaries-spherical.tgz
    wget http://tile.openstreetmap.org/processed_p.tar.bz2
    wget http://tile.openstreetmap.org/shoreline_300.tar.bz2
    wget http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/10m-populated-places.zip
    wget http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/110m/cultural/110m-admin-0-boundary-lines.zip
    tar xzf world_boundaries-spherical.tgz
    tar xjf processed_p.tar.bz2 -C world_boundaries
    tar xjf shoreline_300.tar.bz2 -C world_boundaries
    unzip 10m-populated-places.zip -d world_boundaries
    unzip 110m-admin-0-boundary-lines.zip -d world_boundaries
    echo "Boundary files unzipped in $BASE_DIR/tmp/world_boundaries"
    cd ..
fi

# 2. Checkout mapnik, 0.7 branch

if [[ "$@" =~ 'mapnik' ]]
then
    cd tmp
    svn checkout -r 27279 http://svn.openstreetmap.org/applications/rendering/mapnik
    echo "Mapnik OSM styling in $BASE_DIR/tmp/mapnik"
    cd ..
fi

# 3. Generate the XML

if [[ "$@" =~ 'xml' ]]
then
    MYSOCIETY_DIR=$BASE_DIR/tilma/mapnik
    cd mapnik
    ./generate_xml.py $MYSOCIETY_DIR/osm-names.xml ../tmp/mapumental-names.xml --world_boundaries $BASE_DIR/world_boundaries --symbols $BASE_DIR/mapnik/symbols --dbname openstreetmap --user openstreetmap --host $HOST --port 5432 --accept-none
    ./generate_xml.py $MYSOCIETY_DIR/osm-grey.xml ../tmp/mapumental-map.xml --world_boundaries $BASE_DIR/world_boundaries --symbols $BASE_DIR/mapnik/symbols --dbname openstreetmap --user openstreetmap --host $HOST --port 5432 --accept-none
    ./generate_xml.py osm.xml ../tmp/osm.xml --world_boundaries $BASE_DIR/world_boundaries --symbols $BASE_DIR/mapnik/symbols --dbname openstreetmap --user openstreetmap --host $HOST --port 5432 --accept-none
    echo "New XML files present in $BASE_DIR/tmp/"
    cd ..
fi

