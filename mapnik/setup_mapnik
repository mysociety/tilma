# Instructions from http://wiki.openstreetmap.org/wiki/Mapnik
# Ignoring the database set-up, assume that's done separately.

# 1. Get the external shapefile data for low level things

BASE_DIR=/data/vhost/tilma.mysociety.org
HOST=elephant.ukcod.org.uk

cd $BASE_DIR

if [ ! -f world_boundaries/places.shp ]
then
    mkdir -p tmp
    cd tmp
    wget http://tile.openstreetmap.org/world_boundaries-spherical.tgz
    wget http://tile.openstreetmap.org/processed_p.tar.bz2
    wget http://tile.openstreetmap.org/shoreline_300.tar.bz2
    wget http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/10m-populated-places.zip
    wget http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/110m/cultural/110m-admin-0-boundary-lines.zip
    tar xzf world_boundaries-spherical.tgz
    tar xjf processed_p.tar.bz2 -C world_boundaries
    tar xjf shoreline_300.tar.bz2 -C world_boundaries
    unzip 10m-populated-places.zip -d world_boundaries
    unzip 110m-admin-0-boundary-lines.zip -d world_boundaries
    mv world_boundaries/* ../world_boundaries/*
    cd ..
    rm -rf tmp
fi

# 2. Checkout mapnik

if [ ! -d mapnik ]
then
    svn checkout http://svn.openstreetmap.org/applications/rendering/mapnik
fi

# 3. Generate the XML

MYSOCIETY_DIR=$BASE_DIR/tilma/mapnik
cd mapnik
./generate_xml.py $MYSOCIETY_DIR/osm-names.xml ../osm/mapumental-names.xml.new --world_boundaries $BASE_DIR/world_boundaries --symbols $BASE_DIR/mapnik/symbols --dbname openstreetmap --user openstreetmap --host $HOST --port 5432 --accept-none
./generate_xml.py $MYSOCIETY_DIR/osm-grey.xml ../osm/mapumental-map.xml.new --world_boundaries $BASE_DIR/world_boundaries --symbols $BASE_DIR/mapnik/symbols --dbname openstreetmap --user openstreetmap --host $HOST --port 5432 --accept-none
./generate_xml.py osm.xml ../osm/osm.xml.new --world_boundaries $BASE_DIR/world_boundaries --symbols $BASE_DIR/mapnik/symbols --dbname openstreetmap --user openstreetmap --host $HOST --port 5432 --accept-none

